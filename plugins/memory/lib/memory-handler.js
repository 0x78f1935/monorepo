"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.fileExist = exports.noSuchFile = void 0;

var _httpErrors = _interopRequireDefault(require("http-errors"));

var _memoryFs = _interopRequireDefault(require("memory-fs"));

var _streams = require("@verdaccio/streams");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const noSuchFile = 'ENOENT';
exports.noSuchFile = noSuchFile;
const fileExist = 'EEXISTS';
exports.fileExist = fileExist;

const fSError = function (message, code = 404) {
  const err = (0, _httpErrors.default)(code, message);
  err.code = message;
  return err;
};

const noPackageFoundError = function (message = 'no such package') {
  const err = (0, _httpErrors.default)(404, message);
  err.code = noSuchFile;
  return err;
};

const fs = new _memoryFs.default();

class MemoryHandler {
  constructor(packageName, data, logger) {
    _defineProperty(this, "data", void 0);

    _defineProperty(this, "name", void 0);

    _defineProperty(this, "path", void 0);

    _defineProperty(this, "logger", void 0);

    // this is not need it
    this.data = data;
    this.name = packageName;
    this.logger = logger;
    this.path = '/';
  }

  updatePackage(pkgFileName, updateHandler, onWrite, transformPackage, onEnd) {
    let json = this._getStorage(pkgFileName);

    try {
      json = JSON.parse(json);
    } catch (err) {
      return onEnd(err);
    }

    updateHandler(json, err => {
      if (err) {
        return onEnd(err);
      }

      try {
        onWrite(pkgFileName, transformPackage(json), onEnd);
      } catch (err) {
        return onEnd(fSError('error on parse', 500));
      }
    });
  }

  deletePackage(pkgName, callback) {
    delete this.data[pkgName];
    callback(null);
  }

  removePackage(callback) {
    callback(null);
  }

  createPackage(name, value, cb) {
    this.savePackage(name, value, cb);
  }

  savePackage(name, value, cb) {
    try {
      const json = JSON.stringify(value, null, '\t');
      this.data[name] = json;
    } catch (err) {
      cb(fSError(err.message, 500));
    }

    cb(null);
  }

  readPackage(name, cb) {
    const json = this._getStorage(name);

    const isJson = typeof json === 'undefined';

    try {
      cb(isJson ? noPackageFoundError() : null, JSON.parse(json));
    } catch (err) {
      cb(noPackageFoundError());
    }
  }

  writeTarball(name) {
    const uploadStream = new _streams.UploadTarball({});
    const temporalName = `/${name}`;
    process.nextTick(function () {
      fs.exists(temporalName, function (exists) {
        if (exists) {
          return uploadStream.emit('error', fSError(fileExist));
        }

        try {
          const file = fs.createWriteStream(temporalName);
          uploadStream.pipe(file);

          uploadStream.done = function () {
            const onEnd = function () {
              uploadStream.emit('success');
            };

            uploadStream.on('end', onEnd);
          };

          uploadStream.abort = function () {
            uploadStream.emit('error', fSError('transmision aborted', 400));
            file.end();
          };

          uploadStream.emit('open');
        } catch (err) {
          uploadStream.emit('error', err);
        }
      });
    });
    return uploadStream;
  }

  readTarball(name) {
    const pathName = `/${name}`;
    const readTarballStream = new _streams.ReadTarball({});
    process.nextTick(function () {
      fs.exists(pathName, function (exists) {
        if (!exists) {
          readTarballStream.emit('error', noPackageFoundError());
        } else {
          const readStream = fs.createReadStream(pathName);
          readTarballStream.emit('content-length', fs.data[name].length);
          readTarballStream.emit('open');
          readStream.pipe(readTarballStream);
          readStream.on('error', error => {
            readTarballStream.emit('error', error);
          });

          readTarballStream.abort = function () {
            readStream.destroy(fSError('read has been aborted', 400));
          };
        }
      });
    });
    return readTarballStream;
  }

  _getStorage(name = '') {
    return this.data[name];
  }

}

var _default = MemoryHandler;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tZW1vcnktaGFuZGxlci50cyJdLCJuYW1lcyI6WyJub1N1Y2hGaWxlIiwiZmlsZUV4aXN0IiwiZlNFcnJvciIsIm1lc3NhZ2UiLCJjb2RlIiwiZXJyIiwibm9QYWNrYWdlRm91bmRFcnJvciIsImZzIiwiTWVtb3J5RmlsZVN5c3RlbSIsIk1lbW9yeUhhbmRsZXIiLCJjb25zdHJ1Y3RvciIsInBhY2thZ2VOYW1lIiwiZGF0YSIsImxvZ2dlciIsIm5hbWUiLCJwYXRoIiwidXBkYXRlUGFja2FnZSIsInBrZ0ZpbGVOYW1lIiwidXBkYXRlSGFuZGxlciIsIm9uV3JpdGUiLCJ0cmFuc2Zvcm1QYWNrYWdlIiwib25FbmQiLCJqc29uIiwiX2dldFN0b3JhZ2UiLCJKU09OIiwicGFyc2UiLCJkZWxldGVQYWNrYWdlIiwicGtnTmFtZSIsImNhbGxiYWNrIiwicmVtb3ZlUGFja2FnZSIsImNyZWF0ZVBhY2thZ2UiLCJ2YWx1ZSIsImNiIiwic2F2ZVBhY2thZ2UiLCJzdHJpbmdpZnkiLCJyZWFkUGFja2FnZSIsImlzSnNvbiIsIndyaXRlVGFyYmFsbCIsInVwbG9hZFN0cmVhbSIsIlVwbG9hZFRhcmJhbGwiLCJ0ZW1wb3JhbE5hbWUiLCJwcm9jZXNzIiwibmV4dFRpY2siLCJleGlzdHMiLCJlbWl0IiwiZmlsZSIsImNyZWF0ZVdyaXRlU3RyZWFtIiwicGlwZSIsImRvbmUiLCJvbiIsImFib3J0IiwiZW5kIiwicmVhZFRhcmJhbGwiLCJwYXRoTmFtZSIsInJlYWRUYXJiYWxsU3RyZWFtIiwiUmVhZFRhcmJhbGwiLCJyZWFkU3RyZWFtIiwiY3JlYXRlUmVhZFN0cmVhbSIsImxlbmd0aCIsImVycm9yIiwiZGVzdHJveSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUVBOztBQUNBOzs7Ozs7QUFHTyxNQUFNQSxVQUFVLEdBQUcsUUFBbkI7O0FBQ0EsTUFBTUMsU0FBUyxHQUFHLFNBQWxCOzs7QUFFUCxNQUFNQyxPQUFPLEdBQUcsVUFBU0MsT0FBVCxFQUEw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LEVBQXlDckMsRUFBRSxDQUFDSyxJQUFILENBQVFFLElBQVIsRUFBYzRDLE1BQXZEO0FBQ0FKLFVBQUFBLGlCQUFpQixDQUFDVixJQUFsQixDQUF1QixNQUF2QjtBQUNBWSxVQUFBQSxVQUFVLENBQUNULElBQVgsQ0FBZ0JPLGlCQUFoQjtBQUNBRSxVQUFBQSxVQUFVLENBQUNQLEVBQVgsQ0FBYyxPQUFkLEVBQXdCVSxLQUFELElBQWdCO0FBQ3JDTCxZQUFBQSxpQkFBaUIsQ0FBQ1YsSUFBbEIsQ0FBdUIsT0FBdkIsRUFBZ0NlLEtBQWhDO0FBQ0QsV0FGRDs7QUFJQUwsVUFBQUEsaUJBQWlCLENBQUNKLEtBQWxCLEdBQTBCLFlBQVc7QUFDbkNNLFlBQUFBLFVBQVUsQ0FBQ0ksT0FBWCxDQUFtQjFELE9BQU8sQ0FBQyx1QkFBRCxFQUEwQixHQUExQixDQUExQjtBQUNELFdBRkQ7QUFHRDtBQUNGLE9BakJEO0FBa0JELEtBbkJEO0FBcUJBLFdBQU9vRCxpQkFBUDtBQUNEOztBQUVEL0IsRUFBQUEsV0FBVyxDQUFDVCxJQUFZLEdBQUcsRUFBaEIsRUFBNEI7QUFDckMsV0FBTyxLQUFLRixJQUFMLENBQVVFLElBQVYsQ0FBUDtBQUNEOztBQTVJbUQ7O2VBK0l2Q0wsYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjcmVhdGVFcnJvciwgeyBIdHRwRXJyb3IgfSBmcm9tICdodHRwLWVycm9ycyc7XG5cbmltcG9ydCBNZW1vcnlGaWxlU3lzdGVtIGZyb20gJ21lbW9yeS1mcyc7XG5pbXBvcnQgeyBVcGxvYWRUYXJiYWxsLCBSZWFkVGFyYmFsbCB9IGZyb20gJ0B2ZXJkYWNjaW8vc3RyZWFtcyc7XG5pbXBvcnQgeyBDYWxsYmFjaywgTG9nZ2VyLCBJUGFja2FnZVN0b3JhZ2VNYW5hZ2VyLCBJVXBsb2FkVGFyYmFsbCwgSVJlYWRUYXJiYWxsIH0gZnJvbSAnQHZlcmRhY2Npby90eXBlcyc7XG5cbmV4cG9ydCBjb25zdCBub1N1Y2hGaWxlID0gJ0VOT0VOVCc7XG5leHBvcnQgY29uc3QgZmlsZUV4aXN0ID0gJ0VFWElTVFMnO1xuXG5jb25zdCBmU0Vycm9yID0gZnVuY3Rpb24obWVzc2FnZTogc3RyaW5nLCBjb2RlOiBudW1iZXIgPSA0MDQpOiBIdHRwRXJyb3Ige1xuICBjb25zdCBlcnI6IEh0dHBFcnJvciA9IGNyZWF0ZUVycm9yKGNvZGUsIG1lc3NhZ2UpO1xuXG4gIGVyci5jb2RlID0gbWVzc2FnZTtcblxuICByZXR1cm4gZXJyO1xufTtcblxuY29uc3Qgbm9QYWNrYWdlRm91bmRFcnJvciA9IGZ1bmN0aW9uKG1lc3NhZ2UgPSAnbm8gc3VjaCBwYWNrYWdlJykge1xuICBjb25zdCBlcnI6IEh0dHBFcnJvciA9IGNyZWF0ZUVycm9yKDQwNCwgbWVzc2FnZSk7XG5cbiAgZXJyLmNvZGUgPSBub1N1Y2hGaWxlO1xuICByZXR1cm4gZXJyO1xufTtcblxuY29uc3QgZnMgPSBuZXcgTWVtb3J5RmlsZVN5c3RlbSgpO1xuXG5jbGFzcyBNZW1vcnlIYW5kbGVyIGltcGxlbWVudHMgSVBhY2thZ2VTdG9yYWdlTWFuYWdlciB7XG4gIGRhdGE6IGFueTtcbiAgbmFtZTogc3RyaW5nO1xuICBwYXRoOiBzdHJpbmc7XG4gIGxvZ2dlcjogTG9nZ2VyO1xuXG4gIGNvbnN0cnVjdG9yKHBhY2thZ2VOYW1lOiBzdHJpbmcsIGRhdGE6IGFueSwgbG9nZ2VyOiBMb2dnZXIpIHtcbiAgICAvLyB0aGlzIGlzIG5vdCBuZWVkIGl0XG4gICAgdGhpcy5kYXRhID0gZGF0YTtcbiAgICB0aGlzLm5hbWUgPSBwYWNrYWdlTmFtZTtcbiAgICB0aGlzLmxvZ2dlciA9IGxvZ2dlcjtcbiAgICB0aGlzLnBhdGggPSAnLyc7XG4gIH1cblxuICB1cGRhdGVQYWNrYWdlKHBrZ0ZpbGVOYW1lOiBzdHJpbmcsIHVwZGF0ZUhhbmRsZXI6IENhbGxiYWNrLCBvbldyaXRlOiBDYWxsYmFjaywgdHJhbnNmb3JtUGFja2FnZTogRnVuY3Rpb24sIG9uRW5kOiBDYWxsYmFjayk6IHZvaWQge1xuICAgIGxldCBqc29uID0gdGhpcy5fZ2V0U3RvcmFnZShwa2dGaWxlTmFtZSk7XG5cbiAgICB0cnkge1xuICAgICAganNvbiA9IEpTT04ucGFyc2UoanNvbik7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4gb25FbmQoZXJyKTtcbiAgICB9XG5cbiAgICB1cGRhdGVIYW5kbGVyKGpzb24sIChlcnI6IGFueSkgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICByZXR1cm4gb25FbmQoZXJyKTtcbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIG9uV3JpdGUocGtnRmlsZU5hbWUsIHRyYW5zZm9ybVBhY2thZ2UoanNvbiksIG9uRW5kKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZXR1cm4gb25FbmQoZlNFcnJvcignZXJyb3Igb24gcGFyc2UnLCA1MDApKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGRlbGV0ZVBhY2thZ2UocGtnTmFtZTogc3RyaW5nLCBjYWxsYmFjazogQ2FsbGJhY2spIHtcbiAgICBkZWxldGUgdGhpcy5kYXRhW3BrZ05hbWVdO1xuICAgIGNhbGxiYWNrKG51bGwpO1xuICB9XG5cbiAgcmVtb3ZlUGFja2FnZShjYWxsYmFjazogQ2FsbGJhY2spOiB2b2lkIHtcbiAgICBjYWxsYmFjayhudWxsKTtcbiAgfVxuXG4gIGNyZWF0ZVBhY2thZ2UobmFtZTogc3RyaW5nLCB2YWx1ZTogUmVjb3JkPHN0cmluZywgYW55PiwgY2I6IEZ1bmN0aW9uKTogdm9pZCB7XG4gICAgdGhpcy5zYXZlUGFja2FnZShuYW1lLCB2YWx1ZSwgY2IpO1xuICB9XG5cbiAgc2F2ZVBhY2thZ2UobmFtZTogc3RyaW5nLCB2YWx1ZTogUmVjb3JkPHN0cmluZywgYW55PiwgY2I6IEZ1bmN0aW9uKTogdm9pZCB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGpzb246IHN0cmluZyA9IEpTT04uc3RyaW5naWZ5KHZhbHVlLCBudWxsLCAnXFx0Jyk7XG5cbiAgICAgIHRoaXMuZGF0YVtuYW1lXSA9IGpzb247XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjYihmU0Vycm9yKGVyci5tZXNzYWdlLCA1MDApKTtcbiAgICB9XG5cbiAgICBjYihudWxsKTtcbiAgfVxuXG4gIHJlYWRQYWNrYWdlKG5hbWU6IHN0cmluZywgY2I6IEZ1bmN0aW9uKTogdm9pZCB7XG4gICAgY29uc3QganNvbiA9IHRoaXMuX2dldFN0b3JhZ2UobmFtZSk7XG4gICAgY29uc3QgaXNKc29uID0gdHlwZW9mIGpzb24gPT09ICd1bmRlZmluZWQnO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNiKGlzSnNvbiA/IG5vUGFja2FnZUZvdW5kRXJyb3IoKSA6IG51bGwsIEpTT04ucGFyc2UoanNvbikpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY2Iobm9QYWNrYWdlRm91bmRFcnJvcigpKTtcbiAgICB9XG4gIH1cblxuICB3cml0ZVRhcmJhbGwobmFtZTogc3RyaW5nKSB7XG4gICAgY29uc3QgdXBsb2FkU3RyZWFtOiBJVXBsb2FkVGFyYmFsbCA9IG5ldyBVcGxvYWRUYXJiYWxsKHt9KTtcbiAgICBjb25zdCB0ZW1wb3JhbE5hbWUgPSBgLyR7bmFtZX1gO1xuXG4gICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHtcbiAgICAgIGZzLmV4aXN0cyh0ZW1wb3JhbE5hbWUsIGZ1bmN0aW9uKGV4aXN0cykge1xuICAgICAgICBpZiAoZXhpc3RzKSB7XG4gICAgICAgICAgcmV0dXJuIHVwbG9hZFN0cmVhbS5lbWl0KCdlcnJvcicsIGZTRXJyb3IoZmlsZUV4aXN0KSk7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IGZpbGUgPSBmcy5jcmVhdGVXcml0ZVN0cmVhbSh0ZW1wb3JhbE5hbWUpO1xuXG4gICAgICAgICAgdXBsb2FkU3RyZWFtLnBpcGUoZmlsZSk7XG5cbiAgICAgICAgICB1cGxvYWRTdHJlYW0uZG9uZSA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgY29uc3Qgb25FbmQgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgdXBsb2FkU3RyZWFtLmVtaXQoJ3N1Y2Nlc3MnKTtcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHVwbG9hZFN0cmVhbS5vbignZW5kJywgb25FbmQpO1xuICAgICAgICAgIH07XG5cbiAgICAgICAgICB1cGxvYWRTdHJlYW0uYWJvcnQgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHVwbG9hZFN0cmVhbS5lbWl0KCdlcnJvcicsIGZTRXJyb3IoJ3RyYW5zbWlzaW9uIGFib3J0ZWQnLCA0MDApKTtcbiAgICAgICAgICAgIGZpbGUuZW5kKCk7XG4gICAgICAgICAgfTtcblxuICAgICAgICAgIHVwbG9hZFN0cmVhbS5lbWl0KCdvcGVuJyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIHVwbG9hZFN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHVwbG9hZFN0cmVhbTtcbiAgfVxuXG4gIHJlYWRUYXJiYWxsKG5hbWU6IHN0cmluZykge1xuICAgIGNvbnN0IHBhdGhOYW1lID0gYC8ke25hbWV9YDtcblxuICAgIGNvbnN0IHJlYWRUYXJiYWxsU3RyZWFtOiBJUmVhZFRhcmJhbGwgPSBuZXcgUmVhZFRhcmJhbGwoe30pO1xuXG4gICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHtcbiAgICAgIGZzLmV4aXN0cyhwYXRoTmFtZSwgZnVuY3Rpb24oZXhpc3RzKSB7XG4gICAgICAgIGlmICghZXhpc3RzKSB7XG4gICAgICAgICAgcmVhZFRhcmJhbGxTdHJlYW0uZW1pdCgnZXJyb3InLCBub1BhY2thZ2VGb3VuZEVycm9yKCkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IHJlYWRTdHJlYW0gPSBmcy5jcmVhdGVSZWFkU3RyZWFtKHBhdGhOYW1lKTtcblxuICAgICAgICAgIHJlYWRUYXJiYWxsU3RyZWFtLmVtaXQoJ2NvbnRlbnQtbGVuZ3RoJywgZnMuZGF0YVtuYW1lXS5sZW5ndGgpO1xuICAgICAgICAgIHJlYWRUYXJiYWxsU3RyZWFtLmVtaXQoJ29wZW4nKTtcbiAgICAgICAgICByZWFkU3RyZWFtLnBpcGUocmVhZFRhcmJhbGxTdHJlYW0pO1xuICAgICAgICAgIHJlYWRTdHJlYW0ub24oJ2Vycm9yJywgKGVycm9yOiBhbnkpID0+IHtcbiAgICAgICAgICAgIHJlYWRUYXJiYWxsU3RyZWFtLmVtaXQoJ2Vycm9yJywgZXJyb3IpO1xuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgcmVhZFRhcmJhbGxTdHJlYW0uYWJvcnQgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHJlYWRTdHJlYW0uZGVzdHJveShmU0Vycm9yKCdyZWFkIGhhcyBiZWVuIGFib3J0ZWQnLCA0MDApKTtcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIHJldHVybiByZWFkVGFyYmFsbFN0cmVhbTtcbiAgfVxuXG4gIF9nZXRTdG9yYWdlKG5hbWU6IHN0cmluZyA9ICcnKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhW25hbWVdO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IE1lbW9yeUhhbmRsZXI7XG4iXX0=